#include "greatest.h"
#include "compiler.h"
#include "list.h"

unsigned char if_out[] = {
  0x1b, 0x4c, 0x75, 0x61, 0x40, 0x01, 0x04, 0x08, 0x08, 0x20, 0x06, 0x09,
  0x08, 0x12, 0xe6, 0x5b, 0xa1, 0xb0, 0xb9, 0xb2, 0x41, 0x08, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x3d, 0x28, 0x6e, 0x6f, 0x6e, 0x65, 0x29,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
  0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x61,
  0x72, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x00,
  0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x67, 0x00,
  0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x80, 0x00, 0x00,
  0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
unsigned int if_out_len = 126;

TEST if_program(void) {
  Function f;
  function_init(&f, "=(none)");

  AstNode ident;
  ast_ident_init(&ident, "var");

  AstNode number;
  ast_number_init(&number, 1);

  AstNode ret;
  ast_return_init(&ret, &number);

  AstNode if_node;
  ast_if_init(&if_node, &ident, &ret, NULL);

  list_push(&f.kstr, ident.as_ident.name);
  list_push(&f.code.as_block.stmts, &if_node);

  unsigned char chunk[1024];
  compile(&f, chunk);

  ASSERT_MEM_EQ(if_out, chunk, if_out_len);
  PASS();
}

unsigned char else_out[] = {
  0x1b, 0x4c, 0x75, 0x61, 0x40, 0x01, 0x04, 0x08, 0x08, 0x20, 0x06, 0x09,
  0x08, 0x12, 0xe6, 0x5b, 0xa1, 0xb0, 0xb9, 0xb2, 0x41, 0x08, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x3d, 0x28, 0x6e, 0x6f, 0x6e, 0x65, 0x29,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
  0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x76, 0x61,
  0x72, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00,
  0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xa7, 0x00,
  0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x80, 0x00, 0x00,
  0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6a, 0x00,
  0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x46, 0x0a, 0x00, 0x80, 0x00, 0x00,
  0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
unsigned int else_out_len = 150;

TEST else_program(void) {
  Function f;
  function_init(&f, "=(none)");

  AstNode ident;
  ast_ident_init(&ident, "var");

  AstNode number1;
  ast_number_init(&number1, 1);

  AstNode number2;
  ast_number_init(&number2, 42);

  AstNode ret1;
  ast_return_init(&ret1, &number1);

  AstNode ret2;
  ast_return_init(&ret2, &number2);

  AstNode if_node;
  ast_if_init(&if_node, &ident, &ret1, &ret2);

  list_push(&f.kstr, ident.as_ident.name);
  list_push(&f.code.as_block.stmts, &if_node);

  unsigned char chunk[1024];
  compile(&f, chunk);

  ASSERT_MEM_EQ(else_out, chunk, else_out_len);
  PASS();
}

extern SUITE(suite_if) {
  RUN_TEST(if_program);
  RUN_TEST(else_program);
}
